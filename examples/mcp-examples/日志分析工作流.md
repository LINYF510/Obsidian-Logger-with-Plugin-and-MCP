# MCP 使用示例：日志分析工作流

**场景**: 使用 MCP 工具分析 Obsidian 插件的日志，快速定位和解决问题

---

## 工作流 1：快速健康检查

**目标**: 快速了解插件运行状况

### 步骤 1：查看日志摘要

在 Cursor Composer 中输入：
```
@obsidian-logger get_log_summary
```

**查看重点**:
- 📈 总行数（是否异常增长）
- 🔴 错误数（是否有错误）
- 🟡 警告数（是否有警告）
- 错误率（是否 > 5%）

**示例输出**:
```
📊 日志统计摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📁 文件路径：C:\...\obsidian-logger\obsidian-debug.log
💾 文件大小：1.23 MB
📈 总行数：5,432
⏱️ 最后更新：2 分钟前

📝 日志级别分布：
├─ 🔵 普通日志（LOG）：5,120 (94.3%)
├─ 🟡 警告日志（WARN）：210 (3.9%)
├─ 🔴 错误日志（ERROR）：102 (1.9%)
└─ ⚪ 调试日志（DEBUG）：0 (0.0%)

📊 统计指标：
├─ 错误率：1.88%
├─ 首条日志：09:15:23.456
└─ 末条日志：11:30:45.789

✅ 日志状态良好
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**判断标准**:
- ✅ 错误率 < 5%：健康
- ⚠️ 错误率 5-10%：需要关注
- 🔴 错误率 > 10%：需要立即处理

---

## 工作流 2：错误排查

**目标**: 快速定位和分析错误

### 步骤 1：查看最近错误

```
@obsidian-logger get_recent_errors limit=5
```

**输出示例**:
```
🔴 最近 5 个错误
────────────────────────────────────────────────────────

1. [11:28:34.123] (行 5420)
   TypeError: Cannot read property 'getValue' of undefined

2. [11:25:12.456] (行 5380)
   ReferenceError: settings is not defined

3. [11:20:45.789] (行 5340)
   TypeError: app.workspace.getActiveFile is not a function

...
```

### 步骤 2：深度分析错误

```
@obsidian-logger analyze_errors time_range_hours=12
```

**输出示例**:
```
🔍 错误深度分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️ 分析范围：最近 12 小时
📊 错误总数：102

📋 错误分类统计：

🔧 TypeError：45 次 (44.1%)
  └─ [11:28:34.123] Cannot read property 'getValue' of undefined
  └─ [11:20:45.789] app.workspace.getActiveFile is not a function
  └─ [10:45:23.456] Cannot call method 'split' of null

🔍 ReferenceError：32 次 (31.4%)
  └─ [11:25:12.456] settings is not defined
  └─ [10:50:30.789] myVariable is not defined

❓ Undefined：25 次 (24.5%)
  └─ [11:15:20.123] Cannot read property 'length' of undefined

────────────────────────────────────────────────────────
💡 修复建议：

🔧 TypeError:
  • 检查变量类型是否匹配
  • 确保函数参数类型正确
  • 添加类型检查和验证

🔍 ReferenceError:
  • 检查变量是否已声明
  • 确认变量作用域
  • 检查拼写错误

❓ Undefined:
  • 检查变量初始化
  • 验证对象属性是否存在
  • 添加空值检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 步骤 3：查看详细日志

```
@obsidian-logger read_logs lines=20 level=error
```

**作用**: 获取错误的上下文信息

---

## 工作流 3：AI 辅助调试

**目标**: 利用 Cursor AI 自动分析和修复

### 完整对话示例

**1. 获取错误信息**
```
@obsidian-logger analyze_errors

AI，请帮我分析这些错误并提供修复方案。
```

**2. Cursor AI 分析**

AI 会自动：
- 阅读错误分析结果
- 识别错误模式
- 提供针对性的修复建议
- 甚至生成修复代码

**3. 验证修复**

修复代码后：
```
@obsidian-logger get_recent_errors limit=10

请确认错误是否已解决。
```

---

## 工作流 4：性能监控

**目标**: 定期监控插件性能

### 每日检查清单

**早晨检查** (9:00 AM):
```
@obsidian-logger get_log_summary

查看昨天的日志摘要，确认：
- 错误率是否正常
- 是否有新的错误类型
- 日志文件大小是否合理
```

**下午检查** (3:00 PM):
```
@obsidian-logger get_recent_errors limit=10

查看最新的错误，确认：
- 是否有重复错误
- 是否有新问题出现
```

**晚上清理** (6:00 PM):
```
@obsidian-logger clear_logs backup=true

清理旧日志，开始新的记录周期
```

---

## 工作流 5：问题复现和调试

**目标**: 复现和调试特定问题

### 步骤 1：清空旧日志

```
@obsidian-logger clear_logs backup=true
```

### 步骤 2：重现问题

在 Obsidian 中执行导致问题的操作

### 步骤 3：立即查看日志

```
@obsidian-logger read_logs lines=50 level=all
```

### 步骤 4：分析错误

```
@obsidian-logger analyze_errors time_range_hours=1
```

**优势**:
- 日志干净，只有相关信息
- 更容易定位问题
- 减少干扰

---

## 工作流 6：批量错误处理

**场景**: 发现多个相同类型的错误

### 步骤 1：识别错误模式

```
@obsidian-logger analyze_errors time_range_hours=24
```

### 步骤 2：提取所有相关错误

```
@obsidian-logger read_logs lines=1000 level=error

AI，请帮我找出所有 TypeError 相关的错误，并统计它们的共同点。
```

### 步骤 3：批量修复

让 AI 生成批量修复方案：
```
根据上面的错误模式，请生成一个统一的修复方案，
包括：
1. 类型检查函数
2. 错误处理包装器
3. 所有需要修改的文件列表
```

---

## 最佳实践

### 1. 定期清理日志

**建议频率**: 每周或当文件 > 10MB 时

```bash
# 每周一早晨
@obsidian-logger clear_logs backup=true
```

**好处**:
- 提高查询速度
- 减少存储空间
- 保留历史备份

### 2. 分级响应

根据错误率采取不同行动：

- **< 1%**: 正常，无需处理
- **1-5%**: 定期检查，收集信息
- **5-10%**: 每日检查，计划修复
- **> 10%**: 立即处理，优先级最高

### 3. 结合 Git 工作流

```bash
# 开发前
git checkout -b fix/error-handling
@obsidian-logger get_recent_errors

# 开发中
# 修改代码...
@obsidian-logger read_logs level=error

# 开发后
@obsidian-logger analyze_errors time_range_hours=1
# 确认错误已修复
git commit -m "fix: resolve TypeError in settings handler"
```

### 4. 文档化问题

创建问题报告：
```
1. 获取错误信息
@obsidian-logger get_recent_errors limit=1 include_stack=true

2. 复制输出到 GitHub Issue
标题：[Bug] TypeError in settings handler
内容：粘贴错误信息

3. 记录修复过程
```

---

## 高级技巧

### 1. 组合多个工具

```
@obsidian-logger 请执行以下操作：
1. 获取日志摘要
2. 如果错误率 > 5%，则深度分析错误
3. 提供修复优先级建议
```

### 2. 自动化分析

创建每日分析脚本（伪代码）：
```
daily_check() {
  summary = call("get_log_summary")
  if summary.error_rate > 5%:
    analysis = call("analyze_errors")
    send_email(analysis)
}
```

### 3. 趋势分析

定期导出日志摘要：
```
# 每天 18:00
@obsidian-logger get_log_summary

# 记录到 Excel/Notion
- 日期：2025-11-02
- 总行数：5,432
- 错误率：1.88%
- 主要错误：TypeError (45次)
```

---

## 故障排查检查清单

遇到问题时，按顺序执行：

- [ ] `@obsidian-logger get_log_file_path` - 确认日志文件存在
- [ ] `@obsidian-logger get_log_summary` - 查看整体情况
- [ ] `@obsidian-logger get_recent_errors` - 查看最新错误
- [ ] `@obsidian-logger read_logs level=error` - 查看详细错误日志
- [ ] `@obsidian-logger analyze_errors` - 深度分析
- [ ] 让 AI 提供修复建议
- [ ] 验证修复
- [ ] 清理日志，开始新周期

---

**提示**: 这些工作流可以根据你的实际需求调整和组合。MCP 工具的强大之处在于它们的可组合性！

