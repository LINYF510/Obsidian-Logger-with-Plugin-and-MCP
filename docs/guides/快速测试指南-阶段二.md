# 阶段二功能快速测试指南

**适用版本**: 阶段二任务 2.1-2.2（日志收集核心功能）  
**更新日期**: 2025-11-02

---

## 📋 测试前准备

### 1. 确认编译成功

```bash
cd global-logger
npm run build
```

确认生成 `main.js` 文件（约 16KB）。

### 2. 安装插件到 Obsidian

**Windows 用户**:
```bash
# 使用管理员权限运行 PowerShell
cd scripts
.\link-plugin.bat
```

**Linux/macOS 用户**:
```bash
cd scripts
chmod +x link-plugin.sh
./link-plugin.sh
```

**或手动复制**:
```bash
# 复制整个 global-logger 目录到 Obsidian 插件目录
cp -r global-logger /path/to/vault/.obsidian/plugins/obsidian-cursor-logger
```

---

## ✅ 快速验证（5 分钟）

### 步骤 1：启用插件

1. 打开 Obsidian
2. 进入 **设置 → 第三方插件**
3. 关闭"安全模式"（如果开启）
4. 刷新插件列表
5. 找到并启用 **"Obsidian Cursor Logger"**

### 步骤 2：检查启动日志

1. 按 `Ctrl+Shift+I` (Windows) 或 `Cmd+Option+I` (Mac) 打开开发者控制台
2. 查看是否有以下输出：

```
🚀 Obsidian Cursor Logger 启动中...
📝 日志模块：已启动
   └─ 日志文件位置：/path/to/obsidian-logger/obsidian-debug.log
✅ Obsidian Cursor Logger 已启动
```

### 步骤 3：测试 Console 拦截

在开发者控制台中输入：

```javascript
console.log('测试日志收集 - LOG');
console.error('测试日志收集 - ERROR');
console.warn('测试日志收集 - WARN');
console.debug('测试日志收集 - DEBUG');
```

### 步骤 4：检查日志文件

1. 找到日志文件位置（通常在 vault 同级目录的 `obsidian-logger` 文件夹）
2. 打开 `obsidian-debug.log`
3. 确认看到类似以下内容：

```
[15:30:45.123] [LOG] 测试日志收集 - LOG
[15:30:45.456] [ERROR] 测试日志收集 - ERROR
[15:30:45.789] [WARN] 测试日志收集 - WARN
[15:30:46.012] [DEBUG] 测试日志收集 - DEBUG
```

### 步骤 5：测试命令面板

1. 按 `Ctrl/Cmd + P` 打开命令面板
2. 输入 "显示日志"
3. 选择 **"📋 显示日志文件路径"**
4. 确认显示通知并复制路径到剪贴板

---

## 🧪 深度测试（可选）

### 1. 测试对象序列化

```javascript
// 在控制台执行
console.log('字符串', 123, true, null, undefined);
console.log({ name: '测试', value: 42, nested: { data: 'hello' } });
console.log([1, 2, 3, 4, 5]);
console.log(new Error('测试错误对象'));
```

### 2. 测试循环引用

```javascript
const obj = { name: 'test' };
obj.self = obj;
console.log('循环引用测试:', obj);
```

预期日志：应包含 `[Circular Reference]` 标记

### 3. 测试缓冲区刷新

```javascript
// 快速生成 150 条日志
for (let i = 0; i < 150; i++) {
  console.log(`批量日志测试 ${i}`);
}
```

预期：
- 前 100 条立即刷新到文件
- 剩余 50 条在 500ms 后刷新

### 4. 测试清空日志

1. 打开命令面板
2. 执行 **"🗑️ 清空全局日志"**
3. 确认显示成功通知
4. 检查日志目录，应该有备份文件

---

## 🐛 故障排查

### 问题 1：插件未显示

**症状**: 插件列表中找不到 "Obsidian Cursor Logger"

**解决方案**:
1. 确认插件目录正确：`.obsidian/plugins/obsidian-cursor-logger/`
2. 确认包含必要文件：`main.js`, `manifest.json`
3. 重启 Obsidian
4. 检查控制台是否有错误信息

### 问题 2：日志文件未创建

**症状**: 找不到 `obsidian-logger` 目录或日志文件

**解决方案**:
1. 检查 vault 的父目录权限
2. 手动创建 `obsidian-logger` 目录
3. 检查控制台是否有文件操作错误
4. 尝试以管理员权限运行 Obsidian（Windows）

### 问题 3：日志未被拦截

**症状**: console 输出但日志文件无内容

**解决方案**:
1. 确认插件已成功加载（检查启动日志）
2. 等待 500ms（定时刷新间隔）
3. 生成超过 100 条日志（触发立即刷新）
4. 重启插件或 Obsidian

### 问题 4：编译错误

**症状**: `npm run build` 失败

**解决方案**:
```bash
# 清理并重新安装依赖
rm -rf node_modules
npm install

# 重新编译
npm run build
```

---

## 📊 性能验证

### CPU 占用测试

```javascript
// 持续产生日志 30 秒
const startTime = Date.now();
const interval = setInterval(() => {
  console.log(`性能测试: ${Date.now() - startTime}ms`);
  if (Date.now() - startTime > 30000) {
    clearInterval(interval);
    console.log('性能测试完成');
  }
}, 100);
```

**观察**: 任务管理器中 Obsidian CPU 占用应保持在 5% 以下

### 内存占用测试

```javascript
// 生成大量日志
for (let i = 0; i < 10000; i++) {
  console.log(`内存测试 ${i}: ${'x'.repeat(100)}`);
}
```

**观察**: Obsidian 内存增长应小于 50MB

---

## ✅ 验收标准

确认以下所有项目：

- [ ] 插件能在 Obsidian 中加载
- [ ] 控制台显示启动日志
- [ ] 日志文件成功创建
- [ ] console.log/error/warn/debug 被正确拦截
- [ ] 日志格式正确（[时间] [级别] 消息）
- [ ] 命令面板中有相关命令
- [ ] "显示日志路径" 命令正常工作
- [ ] "清空日志" 命令正常工作
- [ ] 对象和数组正确序列化
- [ ] Error 对象包含 stack trace
- [ ] 循环引用被正确处理
- [ ] 缓冲区刷新机制工作
- [ ] CPU 占用 < 5%
- [ ] 内存占用 < 50MB

---

## 📝 测试记录

**测试日期**: ___________  
**测试环境**: Obsidian 版本 ___________  
**操作系统**: ___________  
**测试结果**: ⬜ 通过 ⬜ 失败

**问题记录**:
```
（记录遇到的问题和解决方案）
```

---

## 🎯 下一步

测试通过后，可以继续：
1. 开始阶段二任务 2.3（Auto-Reload 模块开发）
2. 开始阶段二任务 2.4（设置界面开发）
3. 或开始阶段三（MCP Server 开发）

---

**文档维护**: LINYF510  
**最后更新**: 2025-11-02

