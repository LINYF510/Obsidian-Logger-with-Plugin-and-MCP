# MCP 工具 API 参考

**版本**: v1.0  
**最后更新**: 2025-11-02

---

## 概述

Obsidian Logger MCP Server 提供 **12 个工具**，分为两大类：

- **日志工具（6个）**: 用于日志读取、分析和管理
- **Auto-Reload 工具（6个）**: 用于插件自动重载的远程管理

所有工具通过 MCP 协议（JSON-RPC 2.0）调用，支持 Cursor IDE 集成。

---

## 日志工具

### 1. read_logs

**描述**: 读取日志内容，支持按级别过滤

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `lines` | number | 否 | 50 | 读取的行数（从文件末尾开始） |
| `level` | string | 否 | "all" | 日志级别过滤（all/log/error/warn/debug） |

**返回格式**:
```
📋 最近 {N} 条日志 (级别: {LEVEL})
────────────────────────────────────────────────────────
[HH:MM:SS.mmm] [LOG] 日志内容...
[HH:MM:SS.mmm] [ERROR] 错误内容...
...
```

**使用示例**:
```json
{
  "name": "read_logs",
  "arguments": {
    "lines": 100,
    "level": "error"
  }
}
```

**典型场景**:
- 查看最近的插件输出
- 快速定位错误信息
- 过滤特定级别的日志

---

### 2. get_log_summary

**描述**: 获取日志统计摘要，包括总数、各级别分布、错误率等

**参数**: 无

**返回格式**:
```
📊 日志统计摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📁 文件路径：{path}
💾 文件大小：{size}
📈 总行数：{total}
⏱️ 最后更新：{time}

📝 日志级别分布：
├─ 🔵 普通日志（LOG）：{count} ({percentage}%)
├─ 🟡 警告日志（WARN）：{count} ({percentage}%)
├─ 🔴 错误日志（ERROR）：{count} ({percentage}%)
└─ ⚪ 调试日志（DEBUG）：{count} ({percentage}%)

📊 统计指标：
├─ 错误率：{rate}%
├─ 首条日志：{first_time}
└─ 末条日志：{last_time}

{状态评估}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**缓存**: 5 分钟 TTL

**典型场景**:
- 快速了解日志整体情况
- 评估插件运行健康度
- 性能监控仪表板

---

### 3. get_recent_errors

**描述**: 获取最近的错误日志

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `limit` | number | 否 | 10 | 返回的错误数量 |
| `include_stack` | boolean | 否 | false | 是否包含堆栈信息 |

**返回格式**:
```
🔴 最近 {N} 个错误
────────────────────────────────────────────────────────

1. [HH:MM:SS.mmm] (行 {line_num})
   {error_message}
   堆栈: (如果 include_stack=true)
     {stack_line_1}
     {stack_line_2}

2. ...
```

**缓存**: 5 分钟 TTL（仅当 include_stack=false）

**典型场景**:
- 快速查看最近发生的错误
- 调试特定问题
- 错误趋势分析

---

### 4. analyze_errors

**描述**: 深度错误分析，包括错误分类、频率统计、模式识别、修复建议

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `time_range_hours` | number | 否 | 24 | 分析的时间范围（小时） |

**返回格式**:
```
🔍 错误深度分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️ 分析范围：最近 {hours} 小时
📊 错误总数：{total}

📋 错误分类统计：

🔧 TypeError：{count} 次 ({percentage}%)
  └─ [timestamp] {example_message}

🔍 ReferenceError：{count} 次 ({percentage}%)
  └─ [timestamp] {example_message}

...

────────────────────────────────────────────────────────
💡 修复建议：

🔧 TypeError:
  • 检查变量类型是否匹配
  • 确保函数参数类型正确
  • 添加类型检查和验证

...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**错误分类**:
- 🔧 TypeError
- 🔍 ReferenceError
- ❓ Undefined
- 🚫 Null Reference
- 🌐 Network Error
- 🔒 Permission Error
- 📁 File Error
- ❗ Other Error

**缓存**: 5 分钟 TTL

**典型场景**:
- AI 辅助调试
- 错误根因分析
- 获取修复建议

---

### 5. get_log_file_path

**描述**: 获取日志文件的绝对路径

**参数**: 无

**返回格式**:
```
📁 日志文件路径
────────────────────────────────────────────────────────
{absolute_path}
状态: {✅ 存在 / ⚠️ 不存在}
```

**典型场景**:
- 获取日志文件位置
- 手动访问日志文件
- 配置其他工具

---

### 6. clear_logs

**描述**: 清空日志文件，可选择是否备份

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `backup` | boolean | 否 | true | 是否备份旧日志 |

**返回格式**:
```
✅ 日志已清空
📦 备份文件: {backup_path}
```

**副作用**:
- 清空所有缓存
- 创建备份文件（如果 backup=true）
- 重置日志文件

**典型场景**:
- 开始新的调试会话
- 清理过大的日志文件
- 重置日志状态

---

## Auto-Reload 工具

### 7. get_auto_reload_status

**描述**: 获取 Auto-Reload 完整状态，包括当前模式、监控列表、配置详情

**参数**: 无

**返回格式**:
```
🤖 Auto-Reload 状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 当前模式：{MODE}
📝 监控插件数：{count}
⏱️ 检查间隔：{interval}ms
🔔 显示通知：{是/否}

📋 监控插件列表：
1. plugin-id-1
2. plugin-id-2
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**典型场景**:
- 查看当前监控状态
- 确认配置是否生效
- 监控系统健康度

---

### 8. get_auto_reload_mode

**描述**: 获取当前监控模式（auto/smart/manual）

**参数**: 无

**返回格式**:
```
🤖 当前监控模式：{MODE}
📝 说明：{模式描述}
```

**模式说明**:
- **auto**: 全自动模式 - 监控所有包含开发标识的插件
- **smart**: 智能模式 - 智能识别开发中的插件
- **manual**: 手动模式 - 仅监控手动选择的插件

**典型场景**:
- 快速查询当前模式
- 确认模式切换结果

---

### 9. set_auto_reload_mode

**描述**: 切换监控模式

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `mode` | string | 是 | - | 监控模式（auto/smart/manual） |

**返回格式**:
```
✅ 已切换到 {MODE} 模式
💡 插件将在检测到配置变化后自动应用新模式
```

**副作用**:
- 修改 data.json 配置文件
- 插件在 ~2 秒内检测到变化并应用
- 监控列表可能自动更新

**典型场景**:
- 远程切换监控模式
- 调整监控策略
- 临时禁用自动重载

---

### 10. manage_watched_plugins

**描述**: 管理监控插件列表

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `action` | string | 是 | - | 操作类型（get/add/remove/set） |
| `plugins` | array | 否 | [] | 插件 ID 列表（add/remove/set 需要） |

**操作类型**:

**get** - 获取监控列表:
```json
{
  "action": "get"
}
```
返回:
```
📋 监控插件列表 ({count} 个)
────────────────────────────────────────────────────────
1. plugin-id-1
2. plugin-id-2
...
```

**add** - 添加插件到监控列表:
```json
{
  "action": "add",
  "plugins": ["plugin-id-1", "plugin-id-2"]
}
```
返回:
```
✅ 已添加 {N}/{total} 个插件到监控列表
```

**remove** - 从监控列表移除插件:
```json
{
  "action": "remove",
  "plugins": ["plugin-id-1"]
}
```
返回:
```
✅ 已从监控列表移除 {N}/{total} 个插件
```

**set** - 设置整个监控列表:
```json
{
  "action": "set",
  "plugins": ["plugin-id-1", "plugin-id-2"]
}
```
返回:
```
✅ 已设置监控列表 ({count} 个插件)
```

**副作用**:
- 修改 data.json 配置文件
- 插件在 ~2 秒内应用变化
- 文件监听器自动更新

**典型场景**:
- 动态调整监控插件
- 批量管理插件列表
- 自动化工作流

---

### 11. trigger_plugin_reload

**描述**: 手动触发指定插件重载

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `plugin_id` | string | 是 | - | 要重载的插件 ID |

**返回格式**:
```
✅ 已触发重载请求: {plugin_id}
💡 插件将在检测到配置变化后执行重载（约 2 秒内）
```

**实现机制**:
1. MCP Server 在 data.json 中添加 `_reloadRequest` 字段
2. 插件每 2 秒检查配置变化
3. 检测到重载请求后执行重载
4. 重载完成后清除请求标记

**副作用**:
- 修改 data.json 配置文件
- 插件将被禁用后重新启用
- 重载日志将被记录

**典型场景**:
- 远程重载插件
- 快速验证修改
- 自动化测试流程

---

### 12. get_reload_statistics

**描述**: 获取插件重载统计信息

**参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `plugin_id` | string | 否 | null | 插件 ID（为空则统计所有插件） |
| `time_range_hours` | number | 否 | 24 | 统计的时间范围（小时） |

**返回格式**:
```
📊 重载统计
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️ 统计范围：最近 {hours} 小时
🔌 插件：{plugin_id / 所有}
🔄 重载次数：{count}

📋 最近 5 次重载：
1. [timestamp] {message}
2. [timestamp] {message}
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**数据来源**:
- 从日志文件中提取重载记录
- 识别包含 "Auto-Reload" 和 "插件已重载" 的日志行
- 统计次数和耗时

**典型场景**:
- 监控重载频率
- 性能分析
- 问题排查

---

## 性能特性

### 缓存机制

以下工具使用缓存提升性能：

| 工具 | 缓存 TTL | 缓存键 |
|------|----------|--------|
| get_log_summary | 5 分钟 | 无 |
| get_recent_errors | 5 分钟 | limit 参数 |
| analyze_errors | 5 分钟 | time_range_hours 参数 |

**缓存失效**:
- 日志文件被修改（watchdog 检测）
- 调用 clear_logs 工具
- 手动调用缓存失效

### 响应时间

| 工具类别 | 目标响应时间 |
|----------|--------------|
| 日志读取 | < 200ms |
| 统计分析 | < 500ms |
| 配置修改 | < 100ms |

---

## 错误处理

所有工具遵循统一的错误处理格式：

**成功响应**: 以 ✅ 开头  
**警告响应**: 以 ⚠️ 开头  
**错误响应**: 以 ❌ 开头

**常见错误**:

| 错误信息 | 原因 | 解决方法 |
|----------|------|----------|
| ⚠️ 日志文件不存在 | 插件未启动或日志未生成 | 启动插件或等待日志生成 |
| ❌ 配置文件格式错误 | data.json 损坏 | 修复 JSON 格式或删除文件重新生成 |
| ⚠️ 插件不存在 | 插件 ID 错误 | 检查插件 ID 拼写 |
| ⚠️ 插件未启用 | 插件已禁用 | 在 Obsidian 中启用插件 |

---

## 最佳实践

### 1. 日志分析工作流

```
1. get_log_summary        # 了解整体情况
2. get_recent_errors      # 查看最近错误
3. analyze_errors         # 深度分析
4. read_logs level=error  # 查看详细日志
```

### 2. Auto-Reload 管理工作流

```
1. get_auto_reload_status            # 查看当前状态
2. set_auto_reload_mode mode=smart   # 切换到智能模式
3. manage_watched_plugins action=get # 确认监控列表
4. trigger_plugin_reload             # 手动触发重载（如需）
```

### 3. 性能优化建议

- **使用缓存**: 频繁调用的工具（如 get_log_summary）会从缓存受益
- **批量操作**: 使用 manage_watched_plugins 的 set 操作批量更新列表
- **按需分析**: 仅在需要时调用 analyze_errors，它消耗较多资源
- **定期清理**: 定期使用 clear_logs 清理过大的日志文件

---

## 集成示例

### Cursor IDE 中使用

在 Cursor 中，可以通过 @ 符号调用 MCP 工具：

```
@obsidian-logger read_logs lines=100 level=error
@obsidian-logger get_log_summary
@obsidian-logger analyze_errors time_range_hours=12
@obsidian-logger set_auto_reload_mode mode=smart
@obsidian-logger trigger_plugin_reload plugin_id=my-plugin
```

### 自动化脚本

通过 MCP 协议的 JSON-RPC 调用：

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "read_logs",
    "arguments": {
      "lines": 50,
      "level": "error"
    }
  }
}
```

---

## 版本历史

### v1.0 (2025-11-02)
- ✅ 初始版本
- ✅ 12 个工具全部实现
- ✅ 缓存系统
- ✅ 文件监听
- ✅ 配置通信机制

---

## 技术支持

**文档**: 参见项目 docs/ 目录  
**问题反馈**: GitHub Issues  
**贡献指南**: CONTRIBUTING.md

---

**维护者**: LINYF510  
**最后更新**: 2025-11-02

