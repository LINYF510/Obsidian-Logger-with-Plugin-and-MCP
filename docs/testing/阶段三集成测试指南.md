# 阶段三：MCP Server 集成测试指南

**版本**: v1.0  
**日期**: 2025-11-02  
**状态**: 待执行

---

## 📋 测试概述

### 测试目标

验证 MCP Server 的所有功能正常工作，包括：
- 12 个 MCP 工具的正确性
- 插件与 MCP Server 的通信
- 缓存系统的有效性
- 性能指标达标
- 异常情况处理

### 测试环境

**必需组件**:
- ✅ Obsidian Logger 插件（已安装并启动）
- ✅ MCP Server（已配置）
- ✅ Cursor IDE（已配置 mcp.json）
- ✅ Python 3.8+
- ✅ 依赖包（mcp, watchdog）

**准备工作**:
```bash
# 1. 安装依赖
cd mcp-server
pip install -r requirements.txt

# 2. 重启 Cursor
# 完全关闭 Cursor 并重新启动

# 3. 确认插件已启动
# 在 Obsidian 中检查 Obsidian Logger 插件状态
```

---

## 🧪 测试场景

### 测试 1：基础连接测试 ✅

**目标**: 验证 MCP Server 能成功启动并连接

**步骤**:
1. 完全关闭 Cursor
2. 重新启动 Cursor
3. 打开 Composer（`Ctrl + I`）
4. 输入 `@`

**验收标准**:
- [ ] 能看到 `@obsidian-logger` 在列表中
- [ ] 选择后能看到工具描述
- [ ] 无错误提示

**故障排查**:
如果看不到 `@obsidian-logger`：
1. 检查 `~/.cursor/mcp.json` 配置是否正确
2. 查看 Cursor 开发者工具（F12）控制台
3. 手动测试 Python 脚本：
   ```bash
   python mcp-server/src/mcp_obsidian_logger.py
   ```

---

### 测试 2：日志工具测试 📝

#### 2.1 get_log_file_path

**输入**:
```
@obsidian-logger get_log_file_path
```

**验收标准**:
- [ ] 返回日志文件的绝对路径
- [ ] 路径格式正确（Windows 反斜杠或 Unix 正斜杠）
- [ ] 显示文件存在状态

**示例输出**:
```
📁 日志文件路径
────────────────────────────────────────────────────────
C:\Users\...\obsidian-logger\obsidian-debug.log
状态: ✅ 存在
```

#### 2.2 read_logs

**输入**:
```
@obsidian-logger read_logs lines=10 level=all
```

**验收标准**:
- [ ] 返回最近 10 条日志
- [ ] 日志格式正确：`[HH:MM:SS.mmm] [LEVEL] message`
- [ ] 包含插件启动日志

**输入**:
```
@obsidian-logger read_logs lines=5 level=error
```

**验收标准**:
- [ ] 只返回错误级别的日志
- [ ] 最多 5 条

#### 2.3 get_log_summary

**输入**:
```
@obsidian-logger get_log_summary
```

**验收标准**:
- [ ] 返回完整的统计摘要
- [ ] 包含：文件大小、总行数、各级别分布、错误率、时间范围
- [ ] 数据准确（可手动验证）
- [ ] 第二次调用显示 "(来自缓存)"

**性能测试**:
- [ ] 首次调用 < 500ms
- [ ] 缓存调用 < 50ms

#### 2.4 get_recent_errors

**准备**: 先在 Obsidian 中制造一些错误（例如：在控制台输入 `throw new Error("test")`）

**输入**:
```
@obsidian-logger get_recent_errors limit=3
```

**验收标准**:
- [ ] 返回最近 3 个错误
- [ ] 包含时间戳、行号、错误消息
- [ ] 按时间倒序排列

**输入**:
```
@obsidian-logger get_recent_errors limit=1 include_stack=true
```

**验收标准**:
- [ ] 包含堆栈信息
- [ ] 堆栈格式正确

#### 2.5 analyze_errors

**输入**:
```
@obsidian-logger analyze_errors time_range_hours=24
```

**验收标准**:
- [ ] 返回错误分类统计
- [ ] 至少识别出 1 种错误类型
- [ ] 包含错误示例
- [ ] 包含修复建议
- [ ] 第二次调用显示 "(来自缓存)"

**验证错误分类**:
- [ ] TypeError 能被识别
- [ ] ReferenceError 能被识别
- [ ] Undefined 能被识别

#### 2.6 clear_logs

**输入**:
```
@obsidian-logger clear_logs backup=true
```

**验收标准**:
- [ ] 返回成功消息
- [ ] 显示备份文件路径
- [ ] 日志文件已清空（可手动验证）
- [ ] 备份文件存在
- [ ] 缓存已清空（再次调用 get_log_summary 应该重新加载）

---

### 测试 3：Auto-Reload 工具测试 🤖

#### 3.1 get_auto_reload_status

**输入**:
```
@obsidian-logger get_auto_reload_status
```

**验收标准**:
- [ ] 返回当前模式
- [ ] 返回监控插件列表
- [ ] 返回检查间隔
- [ ] 返回通知设置
- [ ] 数据与 Obsidian 设置界面一致

#### 3.2 get_auto_reload_mode

**输入**:
```
@obsidian-logger get_auto_reload_mode
```

**验收标准**:
- [ ] 返回当前模式名称
- [ ] 返回模式描述
- [ ] 与 get_auto_reload_status 结果一致

#### 3.3 set_auto_reload_mode

**输入**:
```
@obsidian-logger set_auto_reload_mode mode=manual
```

**验收标准**:
- [ ] 返回成功消息
- [ ] 提示需要等待 ~2 秒
- [ ] 等待 2 秒后，在 Obsidian 设置中验证模式已变更

**输入**:
```
@obsidian-logger set_auto_reload_mode mode=smart
```

**验收标准**:
- [ ] 能切换回 smart 模式
- [ ] Obsidian 中设置已更新

**错误测试**:
```
@obsidian-logger set_auto_reload_mode mode=invalid
```

**验收标准**:
- [ ] 返回错误消息
- [ ] 模式未变更

#### 3.4 manage_watched_plugins

**测试 GET 操作**:
```
@obsidian-logger manage_watched_plugins action=get
```

**验收标准**:
- [ ] 返回当前监控列表
- [ ] 数量正确
- [ ] 与 get_auto_reload_status 一致

**测试 ADD 操作**:
```
@obsidian-logger manage_watched_plugins action=add plugins=["test-plugin-1", "test-plugin-2"]
```

**验收标准**:
- [ ] 返回成功消息
- [ ] 显示添加数量
- [ ] 等待 2 秒后，再次 GET 确认已添加

**测试 REMOVE 操作**:
```
@obsidian-logger manage_watched_plugins action=remove plugins=["test-plugin-1"]
```

**验收标准**:
- [ ] 返回成功消息
- [ ] 等待 2 秒后，确认已移除

**测试 SET 操作**:
```
@obsidian-logger manage_watched_plugins action=set plugins=["obsidian-logger"]
```

**验收标准**:
- [ ] 返回成功消息
- [ ] 列表被完全替换

#### 3.5 trigger_plugin_reload

**准备**: 确保有一个测试插件已安装并启用

**输入**:
```
@obsidian-logger trigger_plugin_reload plugin_id=obsidian-logger
```

**验收标准**:
- [ ] 返回成功消息
- [ ] 等待 2 秒后，在 Obsidian 中看到重载通知
- [ ] 日志中记录重载信息

**错误测试**:
```
@obsidian-logger trigger_plugin_reload plugin_id=non-existent-plugin
```

**验收标准**:
- [ ] （插件检测到后）显示错误通知
- [ ] 不执行重载

#### 3.6 get_reload_statistics

**准备**: 先触发几次重载

**输入**:
```
@obsidian-logger get_reload_statistics time_range_hours=1
```

**验收标准**:
- [ ] 返回重载统计
- [ ] 包含重载次数
- [ ] 包含最近 5 次重载记录
- [ ] 时间戳正确
- [ ] 耗时合理（~100-200ms）

**输入**:
```
@obsidian-logger get_reload_statistics plugin_id=obsidian-logger time_range_hours=1
```

**验收标准**:
- [ ] 只返回指定插件的统计
- [ ] 数据准确

---

### 测试 4：缓存系统测试 💾

**目标**: 验证缓存机制正常工作

#### 4.1 缓存命中测试

**步骤**:
1. 清空日志缓存（重启 MCP Server 或修改日志文件）
2. 调用 `get_log_summary`，记录响应时间 T1
3. 立即再次调用 `get_log_summary`，记录响应时间 T2
4. 检查第二次输出是否包含 "(来自缓存)"

**验收标准**:
- [ ] T1 > 200ms（首次加载）
- [ ] T2 < 50ms（缓存命中）
- [ ] 第二次输出包含缓存标记
- [ ] 两次返回数据一致

#### 4.2 缓存失效测试

**步骤**:
1. 调用 `get_log_summary`（建立缓存）
2. 在 Obsidian 中产生新日志
3. 等待 1 秒（触发文件监听）
4. 再次调用 `get_log_summary`

**验收标准**:
- [ ] 第三次返回的数据包含新日志
- [ ] 响应时间增加（缓存已失效）
- [ ] 不显示缓存标记

#### 4.3 TTL 过期测试

**步骤**:
1. 调用 `get_log_summary`
2. 等待 6 分钟（超过 5 分钟 TTL）
3. 再次调用 `get_log_summary`

**验收标准**:
- [ ] 第二次不显示缓存标记
- [ ] 数据重新加载

---

### 测试 5：性能测试 ⚡

#### 5.1 响应时间测试

**测试各个工具的响应时间**:

| 工具 | 目标响应时间 | 实际时间 | 通过 |
|------|-------------|----------|------|
| get_log_file_path | < 50ms | ___ms | [ ] |
| read_logs (50行) | < 200ms | ___ms | [ ] |
| get_log_summary (首次) | < 500ms | ___ms | [ ] |
| get_log_summary (缓存) | < 50ms | ___ms | [ ] |
| get_recent_errors | < 300ms | ___ms | [ ] |
| analyze_errors | < 500ms | ___ms | [ ] |
| clear_logs | < 200ms | ___ms | [ ] |
| get_auto_reload_status | < 100ms | ___ms | [ ] |
| get_auto_reload_mode | < 50ms | ___ms | [ ] |
| set_auto_reload_mode | < 100ms | ___ms | [ ] |
| manage_watched_plugins | < 100ms | ___ms | [ ] |
| trigger_plugin_reload | < 100ms | ___ms | [ ] |
| get_reload_statistics | < 300ms | ___ms | [ ] |

#### 5.2 大文件性能测试

**准备**: 生成大日志文件（~5MB，~50,000 行）

**测试**:
```
@obsidian-logger read_logs lines=100
@obsidian-logger get_log_summary
@obsidian-logger analyze_errors
```

**验收标准**:
- [ ] read_logs < 300ms
- [ ] get_log_summary < 800ms
- [ ] analyze_errors < 1000ms
- [ ] 无内存溢出
- [ ] 无超时

#### 5.3 并发测试

**步骤**:
同时发起 5 个请求（在 Cursor 中快速连续输入）：
```
@obsidian-logger get_log_summary
@obsidian-logger get_recent_errors
@obsidian-logger analyze_errors
@obsidian-logger get_auto_reload_status
@obsidian-logger read_logs
```

**验收标准**:
- [ ] 所有请求都正常返回
- [ ] 无冲突或错误
- [ ] 响应时间合理

---

### 测试 6：异常情况测试 ⚠️

#### 6.1 日志文件不存在

**步骤**:
1. 手动删除日志文件
2. 调用 `read_logs`

**验收标准**:
- [ ] 返回友好的错误消息
- [ ] 不崩溃
- [ ] 提示文件不存在

#### 6.2 配置文件损坏

**步骤**:
1. 修改 data.json，使其成为无效 JSON
2. 调用 Auto-Reload 工具

**验收标准**:
- [ ] 返回错误消息
- [ ] 不崩溃
- [ ] MCP Server 继续运行

#### 6.3 插件未安装

**步骤**:
```
@obsidian-logger trigger_plugin_reload plugin_id=non-existent-plugin
```

**验收标准**:
- [ ] 返回成功（请求已发送）
- [ ] 插件检测后显示错误通知
- [ ] 日志中记录警告

#### 6.4 参数错误

**测试**:
```
@obsidian-logger read_logs lines=-10
@obsidian-logger set_auto_reload_mode mode=invalid
```

**验收标准**:
- [ ] 返回参数错误消息
- [ ] 不执行操作
- [ ] 不崩溃

---

## 📊 测试结果记录

### 测试执行清单

- [ ] 测试 1：基础连接测试
- [ ] 测试 2.1：get_log_file_path
- [ ] 测试 2.2：read_logs
- [ ] 测试 2.3：get_log_summary
- [ ] 测试 2.4：get_recent_errors
- [ ] 测试 2.5：analyze_errors
- [ ] 测试 2.6：clear_logs
- [ ] 测试 3.1：get_auto_reload_status
- [ ] 测试 3.2：get_auto_reload_mode
- [ ] 测试 3.3：set_auto_reload_mode
- [ ] 测试 3.4：manage_watched_plugins
- [ ] 测试 3.5：trigger_plugin_reload
- [ ] 测试 3.6：get_reload_statistics
- [ ] 测试 4：缓存系统测试
- [ ] 测试 5：性能测试
- [ ] 测试 6：异常情况测试

### 已发现问题

**问题列表**:
（在测试过程中填写）

| # | 问题描述 | 严重性 | 状态 |
|---|---------|--------|------|
| 1 | | | |
| 2 | | | |

### 性能数据

**平均响应时间**:
- 日志工具平均：___ms
- Auto-Reload 工具平均：___ms
- 缓存命中率：___%

**资源占用**:
- MCP Server 内存：___MB
- CPU 使用率：___%

---

## ✅ 测试通过标准

**必须满足**:
- [ ] 所有 12 个工具功能正常
- [ ] 无严重 Bug（导致崩溃或数据丢失）
- [ ] 性能指标 >= 80% 达标
- [ ] 缓存系统正常工作
- [ ] 异常情况能优雅处理

**建议满足**:
- [ ] 所有性能指标 100% 达标
- [ ] 无已知 Bug
- [ ] 缓存命中率 > 80%

---

## 🔄 后续步骤

测试完成后：
1. 记录测试结果
2. 修复发现的 Bug
3. 更新文档（如需要）
4. 准备发布

---

**测试负责人**: ___  
**测试日期**: ___  
**测试环境**: ___  
**测试结果**: ___  

---

**附录**: 详细测试日志请记录在单独的测试报告中。

